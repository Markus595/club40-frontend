<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Club 40² Party Playlist</title>
  <meta name="color-scheme" content="dark light" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <script>
    // Links (kannst du hier oder serverseitig setzen)
    const VOTE_URL = "https://festify.us";
    const DROPBOX_URL = "https://www.dropbox.com/request/z1j5rp2kRCpQ6v2R71Lz";
    const SPOTIFY_URL = "https://open.spotify.com/playlist/1FRH27WUto6I32gBRJNVYp?pi=8Lk5CDHbTDO3U&si=Zo8FSnF0SJ_Hvy96org7Aw";
  </script>

  <!-- Header über QR + Now-Playing (spannt 2 Spalten) -->
  <header id="top">
    <h1 id="title">Club 40² Party Playlist</h1>
  </header>

  <!-- Linke Spalte: 3 QRs untereinander -->
  <div id="qr-col">
    <div class="qr-block"><img class="qr-img" alt="QR-Code: Vote deinen Song" /><p class="qr-label">VOTE DEIN SONG!</p></div>
    <div class="qr-block"><img class="qr-img" alt="QR-Code: Spotify Playlist" /><p class="qr-label">SPOTIFY PLAYLIST</p></div>
    <div class="qr-block"><img class="qr-img" alt="QR-Code: Fotos hochladen" /><p class="qr-label">FOTOS HOCHLADEN</p></div>
  </div>

  <!-- Mittlere Spalte: Now Playing (Cover, Titel, Fortschritt) -->
  <main id="now-col">
    <section class="now-playing" aria-live="polite">
      <img src="" alt="Aktuelles Cover" class="cover" id="now-cover" />
      <div class="song-info">
        <h3 id="now-title">Lade Titel…</h3>
        <p id="now-artist"></p>
      </div>
      <div class="progress-container">
        <div class="progress"><div id="progress-bar"></div></div>
        <div id="time-labels"><span id="progress-start">0:00</span><span id="progress-end">0:00</span></div>
      </div>
    </section>
  </main>

  <!-- Rechte Spalte: Partybild zentriert, mit Luft oben/unten -->
  <div id="right">
    <img src="https://raw.githubusercontent.com/Markus595/club40-frontend/refs/heads/main/assets/Club_40.jpeg" alt="Partyfoto" class="party-img" />
  </div>

  <script>
    // QR Codes setzen
    function setQR(el, url){ el.src = "https://api.qrserver.com/v1/create-qr-code/?size=300x300&data="+encodeURIComponent(url); }
    const imgs = document.querySelectorAll('.qr-img');
    setQR(imgs[0], VOTE_URL);
    setQR(imgs[1], SPOTIFY_URL);
    setQR(imgs[2], DROPBOX_URL);

    // Now Playing Logik
    const API = "https://club-40-2-playlist.onrender.com/now-playing";
    let lastFetchTs=0, progressAtFetch=0, durationMs=0;
    const els = {title:document.getElementById('now-title'), artist:document.getElementById('now-artist'), cover:document.getElementById('now-cover'), bar:document.getElementById('progress-bar'), start:document.getElementById('progress-start'), end:document.getElementById('progress-end')};
    function fmt(ms){ const s=Math.max(0,Math.floor(ms/1000)); const m=Math.floor(s/60); const r=s%60; return m+":"+(r<10?"0":"")+r; }
    function tick(){ if(!durationMs) return requestAnimationFrame(tick); const now=Date.now(); const progressed=progressAtFetch+(now-lastFetchTs); const clamped=Math.min(progressed,durationMs); els.start.textContent=fmt(clamped); els.end.textContent=fmt(durationMs); els.bar.style.width=(clamped/(durationMs||1))*100+"%"; requestAnimationFrame(tick); }
    async function fetchNowPlaying(){ try{ const res=await fetch(API,{cache:'no-store'}); if(!res.ok) throw new Error('HTTP '+res.status); const data=await res.json(); if(!data||!data.name) return; els.title.textContent=data.name; els.artist.textContent=data.artist||''; els.cover.src=data.image||''; durationMs=Number(data.duration_ms)||0; progressAtFetch=Math.min(Number(data.progress_ms)||0,durationMs); lastFetchTs=Date.now(); } catch(e){ console.error('Fehler beim Laden der Daten:', e);} }
    fetchNowPlaying(); setInterval(fetchNowPlaying,5000); requestAnimationFrame(tick);
  </script>
</body>
</html>
