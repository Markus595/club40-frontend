<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Club 40² Party Playlist</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:#111;
      color:#fff;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:2vh 2vw 4vh;
      gap:2vh;
    }
    header{
      text-align:center;
    }
    header h1{
      font-size:clamp(28px,3vw,48px);
      font-weight:700;
    }
    main{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      align-items:flex-start;
      gap:2vw;
      width:100%;
      max-width:1600px;
    }
    .now-playing{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:1vh;
      flex:1 1 500px;
    }
    .cover{
      width:min(48%,320px);
      aspect-ratio:1/1;
      border-radius:12px;
    }
    .song-info h3{
      font-size:clamp(20px,2vw,32px);
      text-align:center;
    }
    .song-info p{
      font-size:clamp(14px,1.4vw,20px);
      text-align:center;
    }
    .progress-container{
      width:min(70%,480px);
    }
    .progress{
      background:#333;
      height:10px;
      border-radius:5px;
      overflow:hidden;
      margin-top:5px;
      margin-bottom:5px;
    }
    #progress-bar{
      background:#1DB954;
      height:100%;
      width:0%;
      transition:width 0.5s linear;
    }
    #time-labels{
      display:flex;
      justify-content:space-between;
      font-size:0.9em;
      color:#aaa;
    }
    #right{
      display:flex;
      justify-content:center;
      align-items:center;
      flex:1 1 400px;
    }
    .party-img{
      max-width:100%;
      max-height:400px;
      object-fit:contain;
      border-radius:14px;
    }
    /* QR Codes unten zentriert */
    #qr-row{
      display:flex;
      justify-content:center;
      gap:4vw;
      flex-wrap:wrap;
      margin-top:2vh;
      width:100%;
    }
    #qr-row .qr-block{
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
      padding:0.5vh 0.5vw;
      text-align:center;
    }
    #qr-row .qr-img{
      width:clamp(90px,8vw,130px);
      height:auto;
      background:#fff;
      padding:4px;
      border-radius:8px;
    }
    #qr-row .qr-label{
      margin-top:.3rem;
      font-weight:900;
      font-size:clamp(11px,0.9vw,14px);
    }
  </style>
</head>
<body>
  <header>
    <h1>Club 40² Party Playlist</h1>
  </header>
  <main>
    <section class="now-playing" aria-live="polite">
      <img src="" alt="Aktuelles Cover" class="cover" id="now-cover" />
      <div class="song-info">
        <h3 id="now-title">Lade Titel…</h3>
        <p id="now-artist"></p>
      </div>
      <div class="progress-container">
        <div class="progress"><div id="progress-bar"></div></div>
        <div id="time-labels"><span id="progress-start">0:00</span><span id="progress-end">0:00</span></div>
      </div>
    </section>
    <div id="right">
      <img src="https://raw.githubusercontent.com/Markus595/club40-frontend/refs/heads/main/assets/Club_40.jpeg" alt="Partyfoto" class="party-img" />
    </div>
  </main>
  <div id="qr-row">
    <div class="qr-block"><img class="qr-img" alt="QR-Code: Vote deinen Song" /><p class="qr-label">VOTE DEIN SONG!</p></div>
    <div class="qr-block"><img class="qr-img" alt="QR-Code: Spotify Playlist" /><p class="qr-label">SPOTIFY PLAYLIST</p></div>
    <div class="qr-block"><img class="qr-img" alt="QR-Code: Fotos hochladen" /><p class="qr-label">FOTOS HOCHLADEN</p></div>
  </div>
  <script>
    const VOTE_URL = "https://festify.us";
    const DROPBOX_URL = "https://www.dropbox.com/request/z1j5rp2kRCpQ6v2R71Lz";
    const SPOTIFY_URL = "https://open.spotify.com/playlist/1FRH27WUto6I32gBRJNVYp?pi=8Lk5CDHbTDO3U&si=Zo8FSnF0SJ_Hvy96org7Aw";
    function setQR(el, url){ el.src = "https://api.qrserver.com/v1/create-qr-code/?size=300x300&data="+encodeURIComponent(url); }
    const imgs = document.querySelectorAll('.qr-img');
    setQR(imgs[0], VOTE_URL);
    setQR(imgs[1], SPOTIFY_URL);
    setQR(imgs[2], DROPBOX_URL);

    const API = "https://club-40-2-playlist.onrender.com/now-playing";
    let lastFetchTs=0, progressAtFetch=0, durationMs=0;
    const els = {title:document.getElementById('now-title'), artist:document.getElementById('now-artist'), cover:document.getElementById('now-cover'), bar:document.getElementById('progress-bar'), start:document.getElementById('progress-start'), end:document.getElementById('progress-end')};
    function fmt(ms){ const s=Math.max(0,Math.floor(ms/1000)); const m=Math.floor(s/60); const r=s%60; return m+":"+(r<10?"0":"")+r; }
    function tick(){
      if(!durationMs) return requestAnimationFrame(tick);
      const now=Date.now();
      const progressed=progressAtFetch+(now-lastFetchTs);
      const clamped=Math.min(progressed,durationMs);
      els.start.textContent=fmt(clamped);
      els.end.textContent=fmt(durationMs - clamped);
      els.bar.style.width=(clamped/(durationMs||1))*100+"%";
      requestAnimationFrame(tick);
    }
    async function fetchNowPlaying(){
      try{
        const res=await fetch(API,{cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data=await res.json();
        if(!data||!data.name) return;
        els.title.textContent=data.name;
        els.artist.textContent=data.artist||'';
        els.cover.src=data.image||'';
        durationMs=Number(data.duration_ms)||0;
        progressAtFetch=Math.min(Number(data.progress_ms)||0,durationMs);
        lastFetchTs=Date.now();
      } catch(e){
        console.error('Fehler beim Laden der Daten:', e);
      }
    }
    fetchNowPlaying();
    setInterval(fetchNowPlaying,5000);
    requestAnimationFrame(tick);
  </script>
</body>
</html>
