<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Club 40² Party Playlist</title>
  <meta name="color-scheme" content="dark light" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <script>
    const VOTE_URL = "https://festify.us";
    const DROPBOX_URL = "https://www.dropbox.com/request/z1j5rp2kRCpQ6v2R71Lz";
    const SPOTIFY_URL = "https://open.spotify.com/playlist/1FRH27WUto6I32gBRJNVYp?pi=8Lk5CDHbTDO3U&si=Zo8FSnF0SJ_Hvy96org7Aw";
  </script>

  <div id="left">
    <header>
      <h1 id="playlist-name">Club 40² Party Playlist</h1>
    </header>

    <div class="qr-column">
      <div id="qr-vote" class="qr-block">
        <img class="qr-img" alt="QR-Code: Vote deinen Song" />
        <p class="qr-label">VOTE DEIN SONG!</p>
      </div>
      <div id="qr-spotify" class="qr-block">
        <img class="qr-img" alt="QR-Code: Spotify Playlist" />
        <p class="qr-label">SPOTIFY PLAYLIST</p>
      </div>
      <div id="qr-photos" class="qr-block">
        <img class="qr-img" alt="QR-Code: Fotos hochladen" />
        <p class="qr-label">FOTOS HOCHLADEN</p>
      </div>
    </div>

    <main>
      <section class="now-playing" aria-live="polite">
        <img src="" alt="Aktuelles Cover" class="cover" id="now-cover" />
        <div class="song-info">
          <h3 id="now-title">Lade Titel…</h3>
          <p id="now-artist"></p>
        </div>
        <div class="progress-container">
          <div class="progress"><div id="progress-bar"></div></div>
          <div id="time-labels">
            <span id="progress-start">0:00</span>
            <span id="progress-end">0:00</span>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="right">
    <div class="party-card">
      <img src="https://raw.githubusercontent.com/Markus595/club40-frontend/refs/heads/main/assets/Club_40.jpeg" alt="Partyfoto" class="party-img" />
    </div>
  </div>

  <script>
    function setQR(el, url) {
      const api = "https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=" + encodeURIComponent(url);
      el.src = api;
    }
    setQR(document.querySelector('#qr-vote .qr-img'), VOTE_URL);
    setQR(document.querySelector('#qr-photos .qr-img'), DROPBOX_URL);
    setQR(document.querySelector('#qr-spotify .qr-img'), SPOTIFY_URL);

    const API = "https://club-40-2-playlist.onrender.com/now-playing";
    let lastFetchTs = 0, progressAtFetch = 0, durationMs = 0, trackKey = "";
    const els = {
      title: document.getElementById("now-title"),
      artist: document.getElementById("now-artist"),
      cover: document.getElementById("now-cover"),
      bar: document.getElementById("progress-bar"),
      start: document.getElementById("progress-start"),
      end: document.getElementById("progress-end"),
    };
    function fmt(ms){ const s=Math.max(0,Math.floor(ms/1000)); const m=Math.floor(s/60); const r=s%60; return m+":"+(r<10?"0":"")+r; }
    function tick(){ if(!durationMs){ return requestAnimationFrame(tick);} const now=Date.now(); const progressed=progressAtFetch+(now-lastFetchTs); const clamped=Math.min(progressed,durationMs); els.start.textContent=fmt(clamped); els.end.textContent=fmt(durationMs); const pct=durationMs?(clamped/durationMs)*100:0; els.bar.style.width=pct.toFixed(2)+"%"; requestAnimationFrame(tick); }
    async function fetchNowPlaying(){
      try{
        const res = await fetch(API,{cache:"no-store"});
        if(!res.ok) throw new Error("HTTP "+res.status);
        const now = await res.json();
        if(!now||!now.name) return;
        const key=[now.name,now.artist,now.image||""].join("|");
        const isNew = key!==trackKey; trackKey=key;
        els.title.textContent=now.name; els.artist.textContent=now.artist||""; document.title = now.name+" – Club 40²";
        els.cover.src = now.image || ""; els.cover.alt = now.name?`Cover: ${now.name}`:"Aktuelles Cover";
        els.cover.onerror = ()=>{ els.cover.onerror=null; els.cover.src = "data:image/svg+xml;charset=utf-8,"+encodeURIComponent("<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='1200'><rect width='100%' height='100%' fill='black'/><text x='50%' y='50%' fill='white' font-size='48' dominant-baseline='middle' text-anchor='middle'>No Cover</text></svg>"); };
        durationMs = Number(now.duration_ms)||0; progressAtFetch = Math.min(Number(now.progress_ms)||0, durationMs); lastFetchTs = Date.now();
        if(isNew){ els.bar.style.width=((progressAtFetch/(durationMs||1))*100).toFixed(2)+"%"; els.start.textContent=fmt(progressAtFetch); els.end.textContent=fmt(durationMs); }
      }catch(err){ console.error("Fehler beim Laden der Daten:", err); }
    }
    fetchNowPlaying(); setInterval(fetchNowPlaying,5000); requestAnimationFrame(tick);
  </script>
</body>
</html>
